# 03 — Node.js Native Binding (napi-rs)

## Summary

Ship a native Node.js binding for Authy using napi-rs. The Rust vault engine compiles directly into the npm package — no separate `authy` binary needed. Published as `authy-cli` on npm (replaces the existing binary wrapper at `npm/authy-cli/`).

## Motivation

The v0.7.0 TypeScript SDK (`authy-secrets`) and the binary wrapper (`authy-cli` on npm) both require the Rust binary on PATH. A native binding embeds the vault engine into the npm package. One `npm install` gets everything.

## Current Behavior

```typescript
// v0.7.0 — subprocess wrapper
import { Authy } from "authy-secrets";
const client = new Authy();  // requires authy binary on PATH
const value = await client.get("db-url");  // shells out to authy CLI
```

## Proposed Behavior

```typescript
// v0.7.1 — native binding (synchronous FFI)
import { Authy } from "authy-cli";
const client = new Authy({ passphrase: "..." });  // no binary needed
const value = client.get("db-url");  // direct Rust FFI call, synchronous
```

## API Surface

```typescript
import { Authy } from "authy-cli";

// Construction
const client = new Authy({ passphrase: "my-passphrase" });
const client = new Authy({ keyfile: "/path/to/key.age" });

// Core operations (all synchronous)
const value: string = client.get("db-url");               // throws on not found
const value: string | null = client.getOrNull("db-url");  // null if missing
client.store("db-url", "postgres://...");
client.store("db-url", "postgres://...", { force: true });
const removed: boolean = client.remove("db-url");
const version: number = client.rotate("db-url", "new-value");

// List
const names: string[] = client.list();
const names: string[] = client.list({ scope: "deploy" });

// Env map
const env: Record<string, string> = client.buildEnvMap("deploy", true, "_");

// Policy
const allowed: boolean = client.testPolicy("deploy", "db-url");

// Vault management
client.initVault();
Authy.isInitialized();  // static
```

### Error Handling

napi-rs throws standard JavaScript `Error` objects with a typed `code` field:

```typescript
try {
  client.get("missing");
} catch (e) {
  console.log(e.code);    // "not_found"
  console.log(e.message); // "Secret not found: missing"
}
```

Error codes match `AuthyError::error_code()` from the Rust crate.

## Implementation

### Directory Structure

```
bindings/node/
├── Cargo.toml              # napi-rs cdylib crate
├── package.json            # name="authy-cli", napi config
├── src/lib.rs              # #[napi] structs and methods
├── __test__/
│   └── index.spec.ts       # vitest tests
├── build.rs                # napi build script
└── npm/                    # platform packages (auto-generated by napi-rs)
```

### Crate: `bindings/node/Cargo.toml`

- napi-derive cdylib
- Depends on `authy` via path `../..` with `default-features = false`

### Native Module: `bindings/node/src/lib.rs`

- `#[napi] struct Authy` wrapping `authy::api::AuthyClient`
- `#[napi]` methods for each API operation
- Errors converted via `napi::Error::new(Status::GenericFailure, msg)` with `.code` set

### Platform Packages

napi-rs convention for cross-platform native modules:
- `@authy-cli/linux-x64-gnu`
- `@authy-cli/linux-arm64-gnu`
- `@authy-cli/darwin-x64`
- `@authy-cli/darwin-arm64`
- `@authy-cli/win32-x64-msvc`

## Tests

### `__test__/index.spec.ts`

- `test init and store` — create vault, store/get roundtrip
- `test get not found` — verify error with code "not_found"
- `test list with scope` — policy-filtered listing
- `test buildEnvMap` — env var map with transformations
- `test remove and rotate` — lifecycle operations
- `test isInitialized` — static check

All tests use isolated HOME directories via `os.tmpdir()`.

## Acceptance Criteria

- [ ] `npm install authy-cli` installs native binding (no authy binary needed)
- [ ] `import { Authy } from "authy-cli"` works
- [ ] All API methods work synchronously (no async needed for FFI)
- [ ] Errors have typed `.code` field matching Rust error codes
- [ ] TypeScript type declarations included
- [ ] `npm run build` compiles the native module
- [ ] Tests pass with isolated HOME directories
- [ ] Replaces the binary wrapper at `npm/authy-cli/`
